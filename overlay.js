var _a,NameFixRegex=/[\w'-]+/g,RomanNumeralsRegex=/^m{0,4}(?:cm|cd|d?c{0,3})(?:xc|xl|l?x{0,3})(?:ix|iv|v?i{0,3})$/,NumericRegex=/^(?!\d+(st|nd|rd|th)).*\d/,FixName=function(b,a){b=b.replace(NameFixRegex,function(b){b=b.toLowerCase();switch(b){case "a":case "the":case "of":case "and":case "for":return b}return!a&&b.match(RomanNumeralsRegex)||b.match(NumericRegex)?b.toUpperCase():b.charAt(0).toUpperCase()+b.slice(1).toLowerCase()}).replace("(*)","[DoT]");return b.charAt(0).toUpperCase()+b.slice(1)},
Encounter=function(){function b(a){this.Combatants=[];this.IsActive="true"===a.isActive;this.AreaName=FixName(a.Encounter.CurrentZoneName,!1);this.Title=FixName(a.Encounter.title,!1);this.Duration=Number(a.Encounter.DURATION);this.MaxHitDamage=this.TotalHealed=this.TotalDamage=0;for(var b in a.Combatant){var d=new Combatant(a.Combatant[b]);(d.Type!==CombatantType.Combatant||null!==d.ClassJob||0<d.Duration)&&(0<d.Damage||0<d.Healed||0<d.Overhealed)&&(this.Combatants.push(d),this.TotalDamage+=d.Damage,
this.TotalHealed+=d.Healed,d.MaxHitDamage>this.MaxHitDamage&&(this.MaxHitDamage=d.MaxHitDamage))}this.PostProcessPets()}b.prototype.PostProcessPets=function(){for(var a=function(a){var c=b.Combatants[a];if(c){var d=c.Owner;if(d&&c.ClassJob!==ClassJob.Chocobo){var e=Find(b.Combatants,function(a){return a&&a.Name==d});if(e){if(!e.Combatants){var f=Object.create(Combatant.prototype);Object.assign(f,e);e.Combatants=[f];f.Name="Player"}e.Combatants.push(c);e.Damage+=c.Damage;e.Hits+=c.Hits;e.CriticalHits+=
c.CriticalHits;e.DirectHits+=c.DirectHits;e.Last10Seconds+=c.Last10Seconds;e.Last30Seconds+=c.Last30Seconds;e.Healed+=c.Healed;e.Heals+=c.Heals;e.CriticalHeals+=c.CriticalHeals;c.MaxHitDamage>e.MaxHitDamage&&(e.MaxHitDamage=c.MaxHitDamage,e.MaxHitAction=c.MaxHitAction);c.MaxHealHealed>e.MaxHealHealed&&(e.MaxHealHealed=c.MaxHealHealed,e.MaxHealAction=c.MaxHealAction);c.Owner=void 0;b.Combatants[a]=null}}}},b=this,d=0;d<this.Combatants.length;++d)a(d);this.Combatants=this.Combatants.filter(function(a){return a})};
return b}(),Combatant=function(){function b(a){this.Type=CombatantType.Combatant;this.Role=this.ClassJob=null;this.Duration=Number(a.DURATION);this.Damage=Number(a.damage);this.Hits=Number(a.hits);this.CriticalHits=Number(a.crithits);this.DirectHits=Number(a.DirectHitCount);var c=b.SplitMax(a.maxhit);this.MaxHitDamage=c[0];this.MaxHitAction=c[1];this.Last10Seconds="\u221e"===a.Last10DPS?0:30*Number(a.Last30DPS);this.Last30Seconds="\u221e"===a.Last30DPS?0:60*Number(a.Last60DPS);c=Number(a.healed);
this.Overhealed=Math.round(parseFloat(a.OverHealPct)/100*c);this.Healed=c-this.Overhealed;this.Heals=Number(a.heals);this.CriticalHeals=Number(a.critheals);c=b.SplitMax(a.maxhealward);this.MaxHealHealed=c[0];this.MaxHealAction=c[1];this.Deaths=Number(a.deaths);if(""===a.Job){if("Limit Break"===a.name){if(this.Type=CombatantType.LimitBreak,this.Role=b.LimitRole(this),1===this.Hits+this.Heals&&(c=this.MaxHitAction||this.MaxHealAction))this.Name=c}else c=a.name.indexOf(" ("),-1!==c&&(this.Name=a.name.substring(0,
c),this.Owner=FixName(a.name.substring(c+2,a.name.length-1),!1),c=b.PetClassJobRole(this.Name,a),this.ClassJob=c[0],this.Role=c[1]);void 0===this.Name&&(this.Name=FixName(a.name,!1))}else this.ClassJob=ClassJob[a.Job.toUpperCase()]||null,this.Role=RoleMap[this.ClassJob]||null,this.Name=FixName(a.name,!0)}b.SplitMax=function(a){var b=a.lastIndexOf("-"),d=FixName(a.substr(0,b),!1);a=Number(a.substr(b+1));return isNaN(a)?null:[a,d]};b.LimitRole=function(a){switch(a.MaxHitAction){case "Braver":case "Bladedance":case "Final Heaven":case "Dragonsong Dive":case "Chimatsuri":case "Doom of the Living":return 0===
a.Heals?1===a.Hits?Role.DPSMelee:Role.DPS:null;case "Big Shot":case "Desperado":case "Sagittarius Arrow":case "Satellite Beam":return 0===a.Heals?1===a.Hits?Role.DPSRanged:Role.DPS:null;case "Skyshard":case "Starstorm":case "Meteor":case "Teraflare":case "Vermillion Scourge":return 0===a.Heals?1===a.Hits?Role.DPSCaster:Role.DPS:null}switch(a.MaxHealAction){case "Healing Wind":case "Breath of the Earth":case "Pulse of Life":case "Angel Feathers":case "Astral Stasis":return 0===a.Hits?Role.Healer:null}return null};
b.PetClassJobRole=function(a,c){switch(a){case "Garuda-Egi":return[ClassJob.GarudaEgi,Role.DPSCaster];case "Titan-Egi":return[ClassJob.TitanEgi,Role.Tank];case "Ifrit-Egi":return[ClassJob.IfritEgi,Role.DPSMelee];case "Demi-Bahamut":return[ClassJob.DemiBahamut,Role.DPSCaster];case "Eos":return[ClassJob.Eos,Role.Healer];case "Selene":return[ClassJob.Selene,Role.Healer];case "Rook Autoturret":return[ClassJob.RookAutoturret,Role.DPSRanged];case "Bishop Autoturret":return[ClassJob.BishopAutoturret,Role.DPSRanged]}return EndsWith(a,
"Carbuncle")?[ClassJob.Carbuncle,b.CarbuncleRole(c)]:[ClassJob.Chocobo,null]};b.CarbuncleRole=function(a){switch(Head(a.maxhit)){case "Crimson Cyclone":case "Burning Strike":case "Flaiming Crush":case "Inferno":return Role.DPSMelee;case "Gust":case "Backdraft":case "Downburst":case "Wind Blade":case "Shockwave":case "Arial Slash":case "Aerial Blast":return Role.DPSCaster;case "Gouge":case "Shining Topaz":case "Storm":case "Rock Buster":case "Mountain Buster":case "Landslide":case "Earthen Fury":return Role.Tank}};
return b}(),CombatantType;(function(b){b[b.Combatant=0]="Combatant";b[b.LimitBreak=1]="LimitBreak"})(CombatantType||(CombatantType={}));var ClassJob;
(function(b){b.GLA="gla";b.PGL="pgl";b.MRD="mrd";b.LNC="lnc";b.ARC="arc";b.CNJ="cnj";b.THM="thm";b.CRP="crp";b.BSM="bsm";b.ARM="arm";b.GSM="gsm";b.LTW="ltw";b.WVR="wvr";b.ALC="alc";b.CUL="cul";b.MIN="min";b.BTN="btn";b.FSH="fsh";b.PLD="pld";b.MNK="mnk";b.WAR="war";b.DRG="drg";b.BRD="brd";b.WHM="whm";b.BLM="blm";b.ACN="acn";b.SMN="smn";b.SCH="sch";b.ROG="rog";b.NIN="nin";b.MCH="mch";b.DRK="drk";b.AST="ast";b.SAM="sam";b.RDM="rdm";b.BLU="blu";b.Chocobo="chocobo";b.Carbuncle="carbuncle";b.GarudaEgi=
"garuda-egi";b.TitanEgi="titan-egi";b.IfritEgi="ifrit-egi";b.DemiBahamut="demi-bahamut";b.Eos="eos";b.Selene="selene";b.RookAutoturret="rook-autoturret";b.BishopAutoturret="bishop-autoturret"})(ClassJob||(ClassJob={}));var Role;(function(b){b.Tank="tank";b.Healer="healer";b.DPS="dps";b.DPSMelee="dps-melee";b.DPSRanged="dps-ranged";b.DPSCaster="dps-caster";b.DoH="doh";b.DoL="dol"})(Role||(Role={}));
var RoleMap=(_a={},_a[ClassJob.GLA]=Role.Tank,_a[ClassJob.PGL]=Role.DPSMelee,_a[ClassJob.MRD]=Role.Tank,_a[ClassJob.LNC]=Role.DPSMelee,_a[ClassJob.ARC]=Role.DPSRanged,_a[ClassJob.CNJ]=Role.Healer,_a[ClassJob.THM]=Role.DPSCaster,_a[ClassJob.CRP]=Role.DoH,_a[ClassJob.BSM]=Role.DoH,_a[ClassJob.ARM]=Role.DoH,_a[ClassJob.GSM]=Role.DoH,_a[ClassJob.LTW]=Role.DoH,_a[ClassJob.WVR]=Role.DoH,_a[ClassJob.ALC]=Role.DoH,_a[ClassJob.CUL]=Role.DoH,_a[ClassJob.MIN]=Role.DoL,_a[ClassJob.BTN]=Role.DoL,_a[ClassJob.FSH]=
Role.DoL,_a[ClassJob.PLD]=Role.Tank,_a[ClassJob.MNK]=Role.DPSMelee,_a[ClassJob.WAR]=Role.Tank,_a[ClassJob.DRG]=Role.DPSMelee,_a[ClassJob.BRD]=Role.DPSRanged,_a[ClassJob.WHM]=Role.Healer,_a[ClassJob.BLM]=Role.DPSCaster,_a[ClassJob.ACN]=Role.DPSCaster,_a[ClassJob.SMN]=Role.DPSCaster,_a[ClassJob.SCH]=Role.Healer,_a[ClassJob.ROG]=Role.DPSMelee,_a[ClassJob.NIN]=Role.DPSMelee,_a[ClassJob.MCH]=Role.DPSRanged,_a[ClassJob.DRK]=Role.Tank,_a[ClassJob.AST]=Role.Healer,_a[ClassJob.SAM]=Role.DPSMelee,_a[ClassJob.RDM]=
Role.DPSCaster,_a[ClassJob.BLU]=Role.DPSCaster,_a),Head=function(b,a){void 0===a&&(a="-");return b.substring(0,b.indexOf(a))},Tail=function(b,a){void 0===a&&(a="-");return b.substring(b.lastIndexOf(a)+1)},StartsWith=function(b,a){return 0===b.lastIndexOf(a,0)},EndsWith=function(b,a){return-1!==b.indexOf(a,this.length-a.length)},Find=function(b,a){for(var c=0;c<b.length;++c){var d=b[c];if(a(d))return d}},GenerateEncounterDOM=function(b){var a=document.createElement("table");b.IsActive&&a.classList.add("active");
a.appendChild(GenerateCaption(b));var c=b.Combatants;c.sort(Comparator);var d=c.length;if(0<d){a.appendChild(GenerateHeader());for(var f=0;f<d;++f)a.appendChild(GenerateCombatantGroup(b,c[f]))}return a},GenerateCaption=function(b){var a=document.createElement("caption"),c=a.appendChild(document.createElement("ul"));c.appendChild(document.createElement("li")).appendChild(document.createTextNode(ConvertTime(b.Duration)));c.appendChild(document.createElement("li")).appendChild(document.createTextNode(b.Title));
c.appendChild(document.createElement("li")).appendChild(document.createTextNode(b.AreaName));c.appendChild(document.createElement("li")).appendChild(document.createTextNode("Total DPS: "+Rate(b.TotalDamage,b.Duration)));return a},GenerateHeader=function(){var b=document.createElement("thead"),a=b.appendChild(document.createElement("tr"));a.appendChild(document.createElement("th")).appendChild(document.createTextNode("Name"));a.appendChild(document.createElement("th")).appendChild(document.createTextNode("Damage Per Second"));
a.appendChild(document.createElement("th")).appendChild(document.createTextNode("Percent Damage"));a.appendChild(document.createElement("th")).appendChild(document.createTextNode("Highest Damage"));a.appendChild(document.createElement("th")).appendChild(document.createTextNode("Highest Damage Action"));a.appendChild(document.createElement("th")).appendChild(document.createTextNode("Healing Per Second"));a.appendChild(document.createElement("th")).appendChild(document.createTextNode("Overheal Percent"));
a.appendChild(document.createElement("th")).appendChild(document.createTextNode("Critical Hit Rate"));a.appendChild(document.createElement("th")).appendChild(document.createTextNode("Direct Hit Rate"));a.appendChild(document.createElement("th")).appendChild(document.createTextNode("Deaths"));return b},GenerateCombatantGroup=function(b,a){var c=document.createElement("tbody");c.appendChild(GenerateCombatantRow(b,a,!0));c.appendChild(GenerateCombatantBar(b,a));var d=a.Combatants;if(d){d.sort(Comparator);
for(var f=d.length,g=0;g<f;++g)c.appendChild(GenerateCombatantRow(b,d[g],!1)),c.appendChild(GenerateCombatantBar(b,d[g],a))}return c},GenerateCombatantRow=function(b,a,c){var d=document.createElement("tr"),f=d.appendChild(document.createElement("td")),g=d.appendChild(document.createElement("td")),m=d.appendChild(document.createElement("td")),e=d.appendChild(document.createElement("td")),l=d.appendChild(document.createElement("td")),n=d.appendChild(document.createElement("td")),k=d.appendChild(document.createElement("td")),
p=d.appendChild(document.createElement("td")),q=d.appendChild(document.createElement("td")),r=d.appendChild(document.createElement("td"));if(a.Type===CombatantType.LimitBreak)d.classList.add("limit-break");else{if(0!==a.Last10Seconds&&0!==a.Last30Seconds){var h=a.Last10Seconds/(a.Last30Seconds-a.Last10Seconds);b.IsActive&&(1.15<h?g.classList.add("increasing"):.85>h&&g.classList.add("decreasing"))}0<a.Healed&&(h=a.Overhealed/(a.Healed+a.Overhealed),.75<h?k.classList.add("critical"):.5<h&&k.classList.add("warn"),
0<a.Overhealed&&(h=Percent(a.Overhealed,a.Healed+a.Overhealed),"100%"===h&&(h="99%"),k.appendChild(document.createTextNode(h)),c&&0<a.Overhealed&&k.classList.add("overhealed")))}g.appendChild(document.createTextNode(Rate(a.Damage,b.Duration)));n.appendChild(document.createTextNode(Rate(a.Healed,b.Duration)));c&&a.Owner?(g=a.Owner.split(" ",3),f.appendChild(document.createTextNode(a.Name+" ["+(2===g.length?g[0]:a.Owner)+"]"))):f.appendChild(document.createTextNode(a.Name));m.appendChild(document.createTextNode(Percent(a.Damage,
b.TotalDamage)));a.MaxHitDamage||a.MaxHitAction?(e.appendChild(document.createTextNode(a.MaxHitDamage.toString())),l.appendChild(document.createTextNode(a.MaxHitAction||"???"))):l.appendChild(document.createTextNode("\u2012\u2012\u2012"));p.appendChild(document.createTextNode(Percent(a.CriticalHits+a.CriticalHeals,a.Hits+a.Heals)));q.appendChild(document.createTextNode(Percent(a.DirectHits,a.Hits)));r.appendChild(document.createTextNode(a.Deaths.toString()));a.ClassJob&&d.classList.add("classjob-"+
a.ClassJob);a.Role&&d.classList.add("role-"+a.Role);c&&0<a.Deaths&&d.classList.add("died");a.MaxHitDamage==b.MaxHitDamage&&l.classList.add("max-hit");return d},GenerateCombatantBar=function(b,a,c){void 0===c&&(c=null);var d=document.createElement("tr"),f=d.appendChild(document.createElement("td"));f.colSpan=10;f=f.appendChild(document.createElement("div"));c?(f.style.width=c.Damage/b.Combatants[0].Damage*100+"%",0==c.Damage?f.classList.add("no-damage"):f.appendChild(document.createElement("div")).style.width=
a.Damage/c.Damage*100+"%"):(f.style.width=a.Damage/b.Combatants[0].Damage*100+"%",0==a.Damage&&f.classList.add("no-damage"));return d},ConvertTime=function(b){var a=b%60;return 3600<b?Math.floor(b/3600)+":"+Math.floor(b/60)%60+(10>a?":0":":")+a:Math.floor(b/60)%60+(10>a?":0":":")+a},Rate=function(b,a){return 0===b?"\u2012\u2012\u2012":0===a?"\u221e":Math.round(b/a).toString()},Percent=function(b,a){void 0===a&&(a=1);return 0===b||0===a?"":Math.round(b/a*100)+"%"},Comparator=function(b,a){return b.Type!==
a.Type?b.Type-a.Type:b.Damage!==a.Damage?a.Damage-b.Damage:b.Healed!==a.Healed?a.Healed-b.Healed:b.Name.localeCompare(a.Name,void 0,{sensitivity:"base"})},OverlayStateUpdated=function(b){var a=document.documentElement.classList;b.detail.isLocked?a.remove("unlocked"):a.add("unlocked")},OverlayDataUpdated=function(b){if("object"===typeof b&&"object"===typeof b.detail){b=new Encounter(b.detail);b=GenerateEncounterDOM(b);var a=document.getElementById("main-display");if(a.firstChild)for(a.replaceChild(b,
a.firstChild);a.lastChild!==b;)a.lastChild.remove();else a.appendChild(b)}},RegisterEventHandler=function(b,a){document.addEventListener(b,a)};RegisterEventHandler("readystatechange",function(b){"complete"===document.readyState&&(RegisterEventHandler("onOverlayStateUpdate",OverlayStateUpdated),RegisterEventHandler("onOverlayDataUpdate",OverlayDataUpdated),"undefined"===typeof OverlayPluginApi&&(b=document.createElement("script"),b.src="./preview.js",document.head.appendChild(b)))});